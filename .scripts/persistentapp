#!/usr/bin/env bash
#
###################################################################
# Description : Restart a command if it exits, with safeguards
# Args        : command (with arguments) to keep running
# Author      : Maverobot
###################################################################

set -o errexit
set -o pipefail
set -o nounset

MIN_RUNTIME_MS=100

usage() {
    echo "Usage: $0 <command> [args...]"
    exit 1
}

timer_start() {
    STARTTIME=$(date +%s%N)
}

timer_elapsed_ms() {
    local endtime
    endtime=$(date +%s%N)
    echo $(( (endtime - STARTTIME) / 1000000 ))
}

# Validate arguments
if [[ $# -lt 1 ]]; then
    usage
fi

# Preserve command and arguments safely
cmd=( "$@" )

echo "Monitoring command: ${cmd[*]}"
echo "Minimum runtime before restart: ${MIN_RUNTIME_MS} ms"

while true; do
    echo
    echo "Executing command: ${cmd[*]}"

    timer_start
    "${cmd[@]}"
    ret=$?

    elapsed_ms=$(timer_elapsed_ms)

    if (( elapsed_ms < MIN_RUNTIME_MS )); then
        echo "Command exited too quickly (${elapsed_ms} ms)."
        echo "To prevent restart loops, exiting."
        exit 1
    fi

    if (( ret != 0 )); then
        echo "Command exited with non-zero status ($ret)."
        echo "Exiting supervisor."
        exit "$ret"
    fi

    echo "Command exited normally. Restarting..."
done
